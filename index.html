<!DOCTYPE html>
<html>
<head>
  <title>DC.js + Leaflet</title>
  <meta charset="UTF-8">
  <link type="text/css" href="lib/leaflet.css" rel="stylesheet"/>
  <link type="text/css" href="lib/dc.css" rel="stylesheet"/>

  <style>
    #container {
      width:800px;
      margin:20px auto;
    }
    #map {
      width:800px;
      height:400px;
    }
    .dc-chart g.row text {
      fill:black;
    }
  </style>
</head>
<body>

<div id="container">
  <h2>Dolores Park Crimes</h2>
  <div id="map"></div>
  <div id="charts">
    <div id="crimesbyday"></div>
    <div id="category"></div>
    <div id="dayofweek"></div>
  </div>
</div>

<script type="text/javascript" src="lib/d3.js"></script>
<script type="text/javascript" src="lib/crossfilter.js"></script>
<script type="text/javascript" src="lib/dc.js"></script>
<script type="text/javascript" src="lib/leaflet.js"></script>
<script type="text/javascript" src="lib/dc.leaflet.js"></script>
<script type="text/javascript">

  d3.json("dolores.geojson", function(data) {
    drawMarkerArea(data);
  });

  function drawMarkerArea(data) {
    var data = crossfilter(data.geojson_crime.features),
        groupname = "marker-area",
        crime = data.dimension(function(d) { return d.geometry.coordinates[1] + "," + d.geometry.coordinates[0]; }),
        crimeGroup = crime.group().reduceCount(),
        category = data.dimension(function(d) { return d.properties.category; }),
        categoryGroup = category.group().reduceCount(),
        dayofweek = data.dimension(function(d) { return d.properties.dayofweek; }),
        dayofweekGroup = dayofweek.group().reduceCount(),
        crimesbyday = data.dimension(function (d) { return new Date(d.properties.date); }),
        crimesbydayGroup = crimesbyday.group().reduceCount();

    // time scale range
    var topDate = crimesbyday.top(1),
        maxDate = new Date(topDate[0].properties.date),
        bottomDate = crimesbyday.bottom(1),
        minDate = new Date(bottomDate[0].properties.date);

    dc.leafletMarkerChart("#map", groupname)
       .dimension(crime)
       .group(crimeGroup)
       .width(600)
       .height(600)
       .center([37.7595,-122.427])
       .zoom(16)
       .renderPopup(true)
       .filterByArea(true);

    dc.rowChart("#category", groupname)
      .dimension(category)
      .group(categoryGroup)
      .height(500)
      .width(270)
      .elasticX(true)
      .colors(["#2ca25f"])
      .xAxis().ticks(2).tickFormat(d3.format("s"));

    dc.rowChart("#dayofweek", groupname)
      .dimension(dayofweek)
      .group(dayofweekGroup)
      .height(300)
      .width(270)
      .elasticX(true)
      .colors(["#2b8cbe"])
      .xAxis().ticks(2).tickFormat(d3.format("s"));

    dc.barChart("#crimesbyday", groupname)
      .dimension(crimesbyday)
      .group(crimesbydayGroup)
      .width(800)
      .transitionDuration(500)
      .elasticY(true)
      .x(d3.time.scale().domain([minDate, maxDate]))
      .yAxis().ticks(2).tickFormat(d3.format("s"));

    dc.renderAll(groupname);
  }

  </script>

</body>
</html>
